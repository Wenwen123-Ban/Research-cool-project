<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LBAS | Developer Analytics v7.2 Beta</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/dist/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --admin-dark: #0f172a;
        --accent: #38bdf8;
        --success: #22c55e;
        --danger: #ef4444;
        --text-primary-contrast: #ffffff;
        --text-highlight: #ffd54f;
        --text-muted-contrast: rgba(255, 255, 255, 0.75);
      }
      * {
        box-sizing: border-box;
      }
      body {
        background-image: url("https://www.tangubcity.gov.ph/application/files/1116/1768/0018/NEW_6322.JPG");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        font-family: "Inter", sans-serif;
        color: #334155;
        min-height: 100vh;
      }

      .analytics-main {
        position: relative;
        isolation: isolate;
        background-image: url("https://www.tangubcity.gov.ph/application/files/1116/1768/0018/NEW_6322.JPG");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        overflow: hidden;
      }

      .analytics-main::before {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        pointer-events: none;
        z-index: 0;
      }

      .analytics-main > * {
        position: relative;
        z-index: 1;
      }

      .sidebar-header {
        background: var(--admin-dark);
        color: white;
        padding: 25px 0;
        border-bottom: 4px solid var(--accent);
      }

      .stat-card {
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 25px;
        border: none;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.28);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: transform 0.2s;
      }
      .stat-card:hover {
        transform: translateY(-5px);
      }

      .chart-container {
        position: relative;
        height: 320px;
        width: 100%;
      }

      .feedback-scroll {
        max-height: 500px;
        overflow-y: auto;
        padding-right: 10px;
      }
      .feedback-item {
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 5px solid var(--text-highlight);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      }

      .badge-star {
        background: rgba(255, 213, 79, 0.2);
        color: var(--text-highlight);
        border: 1px solid rgba(255, 213, 79, 0.65);
        font-weight: 700;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }
      .pulse-red {
        background: var(--danger);
        box-shadow: 0 0 0 rgba(239, 68, 68, 0.4);
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0px rgba(239, 68, 68, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        }
        100% {
          box-shadow: 0 0 0 0px rgba(239, 68, 68, 0);
        }
      }

      .sync-active {
        color: var(--success);
        font-weight: 800;
        font-size: 0.7rem;
      }



      .analytics-main h1,
      .analytics-main h2,
      .analytics-main h3,
      .analytics-main h4,
      .analytics-main h5,
      .analytics-main h6,
      .analytics-main .text-dark {
        color: var(--text-primary-contrast) !important;
      }

      .analytics-main p,
      .analytics-main small,
      .analytics-main span,
      .analytics-main .text-muted,
      .analytics-main .text-secondary,
      .analytics-main .text-white-50 {
        color: var(--text-muted-contrast) !important;
      }

      .analytics-main .text-primary,
      .analytics-main .text-info,
      .analytics-main .text-warning,
      .analytics-main i.text-primary,
      .analytics-main i.text-info {
        color: var(--text-highlight) !important;
      }

      .analytics-main .alert,
      .analytics-main .badge.bg-light,
      .analytics-main .bg-light {
        background: rgba(0, 0, 0, 0.55) !important;
        color: #fff !important;
        border: 1px solid rgba(255, 255, 255, 0.25) !important;
      }

      .analytics-main .btn-info,
      .analytics-main .btn-success {
        background: #ffd54f !important;
        border-color: #ffd54f !important;
        color: #000 !important;
        font-weight: 700;
      }

      .analytics-main .btn-danger {
        background: #e53935 !important;
        border-color: #e53935 !important;
        color: #fff !important;
      }

      .main-footer {
        margin-top: 40px;
        padding: 18px 12px;
        text-align: center;
        background: #0f172a;
        color: #cbd5e1;
        border-top: 1px solid #1e293b;
      }

      .footer-purpose-link {
        color: #60a5fa;
        font-weight: 700;
        text-decoration: none;
      }
      .footer-purpose-link:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body class="main-wrapper">
    <div class="sidebar-header mb-5 shadow-lg">
      <div class="container d-flex justify-content-between align-items-center">
        <div>
          <h3 class="m-0 fw-black">
            <i class="fas fa-chart-line me-3 text-info"></i>Developer Metrics
          </h3>
          <p class="text-info mb-0 small opacity-75 fw-bold">
            LBAS CENTRAL ANALYTICS ENGINE
          </p>
        </div>
        <div class="d-flex align-items-center gap-4">
          <div class="text-end">
            <span id="syncText" class="sync-active"
              ><i class="fas fa-sync fa-spin me-1"></i> LIVE STREAM ACTIVE</span
            >
            <div class="text-white-50 small" id="lastUpdated">
              Last sync: --:--:--
            </div>
          </div>
          <button
            id="launchBtn"
            class="btn btn-info fw-bold px-4 py-2 rounded-pill"
            onclick="toggleRatingPeriod()"
          >
            INITIALIZING...
          </button>
        </div>
      </div>
    </div>

    <main class="analytics-main content">
      <div class="container pb-5">
      <div
        id="systemStateBanner"
        class="alert alert-dark text-center fw-bold mb-5 border-0 shadow-sm py-3"
        style="border-radius: 15px"
      >
        <span class="status-indicator" id="stateDot"></span>
        DATA COLLECTION STATUS:
        <span id="stateText" class="ms-1">SYNCING WITH SERVER...</span>
      </div>

      <div class="row g-4 mb-5">
        <div class="col-lg-7">
          <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h6 class="fw-bold text-uppercase m-0">Rating Distribution</h6>
              <span class="badge bg-light text-dark border"
                >Quantitative N=<span id="sampleSize">0</span></span
              >
            </div>
            <div class="chart-container">
              <canvas id="ratingsChart"></canvas>
            </div>
          </div>
        </div>

        <div class="col-lg-5">
          <div
            class="stat-card text-center d-flex flex-column justify-content-center h-100 bg-white"
          >
            <p class="text-muted fw-bold text-uppercase small mb-2">
              User Satisfaction Index
            </p>
            <h1
              class="display-1 fw-black text-primary mb-0"
              id="avgRating"
              style="font-size: 6rem"
            >
              0.0
            </h1>
            <div id="starDisplay" class="mb-3 text-warning"></div>
            <div class="p-3 bg-light rounded-4">
              <span class="h5 text-dark fw-bold d-block mb-1" id="totalVotes"
                >0 Total Votes</span
              >
              <small class="text-muted"
                >Aggregated from unique School IDs</small
              >
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="stat-card">
            <h6 class="fw-bold mb-4 text-uppercase">
              <i class="fas fa-comments me-2 text-primary"></i>Qualitative User
              Sentiment
            </h6>
            <div class="feedback-scroll" id="feedbackList"></div>
          </div>
        </div>
      </div>
    </div>
    </main>

    <script>
      let myChart;

      async function toggleRatingPeriod() {
        try {
          const res = await fetch("/api/toggle_rating", { method: "POST" });
          const data = await res.json();
          updateUIState(data.is_enabled);
        } catch (e) {
          alert("Connection Failed: Unable to toggle system state.");
        }
      }

      function updateUIState(isEnabled) {
        const btn = document.getElementById("launchBtn");
        const stateText = document.getElementById("stateText");
        const stateDot = document.getElementById("stateDot");
        const banner = document.getElementById("systemStateBanner");

        if (isEnabled) {
          btn.innerText = "HALT COLLECTION";
          btn.className =
            "btn btn-danger fw-bold px-4 py-2 rounded-pill shadow";
          stateText.innerText = "LIVE DATA COLLECTION ACTIVE";
          stateText.className = "text-danger ms-1";
          stateDot.className = "status-indicator pulse-red";
          banner.className =
            "alert alert-white border-danger text-center fw-bold mb-4 shadow-sm";
        } else {
          btn.innerText = "START RATING PERIOD";
          btn.className =
            "btn btn-success fw-bold px-4 py-2 rounded-pill shadow";
          stateText.innerText = "IDLE - SYSTEM STANDBY";
          stateText.className = "text-muted ms-1";
          stateDot.className = "status-indicator bg-secondary";
          banner.className =
            "alert alert-light text-center fw-bold mb-4 shadow-sm border";
        }
      }

      async function updateAnalytics() {
        try {
          const res = await fetch("/api/ratings_summary");
          const data = await res.json();

          const counts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
          let sum = 0;

          data.forEach((r) => {
            counts[r.stars]++;
            sum += r.stars;
          });

          const total = data.length;
          const avg = total > 0 ? (sum / total).toFixed(1) : "0.0";

          document.getElementById("avgRating").innerText = avg;
          document.getElementById("totalVotes").innerText =
            `${total} Total Verdicts`;
          document.getElementById("sampleSize").innerText = total;
          document.getElementById("lastUpdated").innerText =
            `Last sync: ${new Date().toLocaleTimeString()}`;

          let starsHtml = "";
          for (let i = 1; i <= 5; i++) {
            starsHtml += `<i class="${i <= Math.round(avg) ? "fas" : "far"} fa-star fa-2x mx-1"></i>`;
          }
          document.getElementById("starDisplay").innerHTML = starsHtml;

          updateChart(counts);

          const listContainer = document.getElementById("feedbackList");
          listContainer.innerHTML =
            data
              .slice()
              .reverse()
              .map(
                (r) => `
                <div class="feedback-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="badge badge-star me-2">${r.stars} <i class="fas fa-star"></i></span>
                            <span class="fw-bold text-dark">${r.school_id}</span>
                        </div>
                        <small class="text-muted font-monospace">${r.timestamp}</small>
                    </div>
                    <p class="mb-2 fst-italic text-secondary">"${r.feedback || "No qualitative data provided."}"</p>
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-laptop-code text-muted small"></i>
                        <small class="text-muted" style="font-size: 10px; letter-spacing: 0.5px;">${r.user_agent}</small>
                    </div>
                </div>
            `,
              )
              .join("") ||
            '<div class="text-center py-5 text-muted">Awaiting incoming user verdicts...</div>';
        } catch (e) {
          document.getElementById("syncText").innerHTML =
            "<i class='fas fa-exclamation-triangle'></i> DATABASE DISCONNECTED";
          document.getElementById("syncText").className =
            "text-danger fw-bold small";
        }
      }

      function updateChart(counts) {
        const ctx = document.getElementById("ratingsChart").getContext("2d");
        const chartData = [
          counts[1],
          counts[2],
          counts[3],
          counts[4],
          counts[5],
        ];

        if (myChart) {
          myChart.data.datasets[0].data = chartData;
          myChart.update();
        } else {
          myChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: ["1 Star", "2 Star", "3 Star", "4 Star", "5 Star"],
              datasets: [
                {
                  data: chartData,
                  backgroundColor: [
                    "#f87171",
                    "#fb923c",
                    "#fbbf24",
                    "#a3e635",
                    "#4ade80",
                  ],
                  borderRadius: 12,
                  barThickness: 40,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { display: false },
                  ticks: { stepSize: 1, color: "#94a3b8" },
                },
                x: { grid: { display: false }, ticks: { color: "#94a3b8" } },
              },
            },
          });
        }
      }

      window.onload = () => {
        updateAnalytics();
        fetch("/api/rating_status/DEV_CHECK")
          .then((r) => r.json())
          .then((d) => {
            updateUIState(d.reason !== "Period Closed");
          });
      };

      setInterval(updateAnalytics, 10000);
    </script>

    <footer class="main-footer">
      <p class="m-0 small">The Makers of the System</p>
      <p class="m-0 small mt-1">Purpose: <a class="footer-purpose-link" href="/creators">Creators Page</a></p>
    </footer>
  </body>
</html>
