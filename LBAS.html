<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>LBAS | Secured Mobile Access</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #0f172a;
        --accent: #38bdf8;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --text-primary-contrast: #ffffff;
        --text-highlight: #ffd54f;
        --text-muted-contrast: rgba(255, 255, 255, 0.75);
        --glass-strong: rgba(0, 0, 0, 0.65);
        --glass-border: rgba(255, 255, 255, 0.3);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0;
        background: url("https://www.tangubcity.gov.ph/application/files/1116/1768/0018/NEW_6322.JPG") no-repeat center center;
        background-size: cover;
        background-attachment: scroll;
        background-repeat: no-repeat;
        font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        overflow-x: hidden;
        min-height: 100vh;
      }

      header {
        position: relative;
        z-index: 1000;
      }

      #loginSection,
      #portalSection {
        position: relative;
        isolation: isolate;
        background: transparent;
        overflow: hidden;
      }

      #loginSection::before,
      #portalSection::before {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        pointer-events: none;
        z-index: 0;
      }

      #loginSection > *,
      #portalSection > * {
        position: relative;
        z-index: 1;
      }
      .network-banner {
        background: var(--primary);
        color: var(--accent);
        font-size: 10px;
        text-align: center;
        padding: 4px;
        font-weight: bold;
        letter-spacing: 1px;
      }

      .lbas-definition {
        background: var(--glass-strong);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid var(--glass-border);
        border-left: 4px solid var(--text-highlight);
        color: var(--text-primary-contrast);
      }
      .lbas-letter {
        font-weight: 800;
        color: var(--text-highlight);
        margin-right: 5px;
      }

      .filter-wrapper {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding: 5px 0 15px 0;
        scrollbar-width: none;
        margin-bottom: 8px;
      }
      .cat-pill {
        white-space: nowrap;
        padding: 8px 16px;
        border-radius: 20px;
        background: rgba(0, 0, 0, 0.55);
        border: 1px solid var(--glass-border);
        color: var(--text-primary-contrast);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
      }
      .cat-pill.active {
        background: #ffd54f;
        color: #000;
        border-color: #ffd54f;
        box-shadow: 0 4px 10px rgba(255, 213, 79, 0.45);
      }

      #loginSection {
        min-height: 90vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        flex-direction: column;
      }

      #portalSection,
      #loginSection {
        flex: 1 0 auto;
      }

      #bookContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        padding: 20px;
        scrollbar-gutter: stable;
      }
      .login-card {
        background: var(--glass-strong);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        padding: 30px;
        border-radius: 24px;
        border: 1px solid var(--glass-border);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
        width: 100%;
        max-width: 380px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }
      .login-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 6px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
      }

      .upload-circle {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        background: #f1f5f9;
        border: 2px dashed #cbd5e1;
        margin: 0 auto 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        position: relative;
      }
      .upload-circle img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
      }
      .upload-icon {
        font-size: 24px;
        color: #94a3b8;
      }

      .mobile-nav {
        background: var(--glass-strong);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        padding: 15px 20px;
        border: 1px solid var(--glass-border);
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .book-item,
      .book-card {
        background: var(--glass-strong);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        border-radius: 18px;
        padding: 18px;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
        border: 1px solid var(--glass-border);
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .book-item:hover {
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
      }
      .book-item:active {
        transform: scale(0.98);
      }
      .status-tag {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 10px;
        font-weight: 800;
        padding: 4px 10px;
        border-radius: 10px;
        text-transform: uppercase;
      }
      .tag-available {
        background: #4caf50;
        color: #ffffff;
      }
      .tag-reserved {
        background: #ffb300;
        color: #000000;
      }
      .tag-borrowed {
        background: #fee2e2;
        color: #991b1b;
      }
      .btn-action {
        background: #ffd54f;
        color: #000;
        border: none;
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        font-weight: bold;
        margin-top: 10px;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .btn-action:hover {
        transform: scale(1.03);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      #accountPanel,
      .account-dropdown {
        display: none;
        position: absolute;
        top: calc(100% + 10px);
        right: 20px;
        width: min(420px, calc(100% - 40px));
        background: var(--glass-strong);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        border: 1px solid var(--glass-border);
        border-radius: 14px;
        padding: 25px;
        animation: slideDown 0.3s;
        z-index: 9999;
      }

      .rating-fab {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background: var(--primary);
        color: var(--accent);
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        border: 2px solid var(--accent);
        font-size: 24px;
        display: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        transition: 0.3s;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 3000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        backdrop-filter: blur(4px);
      }
      .custom-modal {
        background: var(--glass-strong);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        width: 100%;
        max-width: 400px;
        border-radius: 25px;
        padding: 30px;
        text-align: center;
        position: relative;
        border: 1px solid var(--glass-border);
        color: var(--text-primary-contrast);
      }
      .star-container {
        font-size: 35px;
        color: #cbd5e1;
        margin: 15px 0;
      }
      .star.selected {
        color: var(--text-highlight);
      }

      #portalSection .container,
      #portalSection .card,
      #portalSection .modal-content {
        background: var(--glass-strong);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        border-radius: 12px;
        border: 1px solid var(--glass-border);
      }

      #loginSection h1,
      #loginSection h2,
      #loginSection h3,
      #loginSection h4,
      #loginSection h5,
      #portalSection h1,
      #portalSection h2,
      #portalSection h3,
      #portalSection h4,
      #portalSection h5,
      #portalSection h6,
      #portalSection .text-dark,
      #portalSection code,
      .modal-overlay .text-dark {
        color: var(--text-primary-contrast) !important;
      }

      #loginSection p,
      #portalSection p,
      #portalSection label,
      #portalSection .text-muted,
      #loginSection .text-muted,
      .modal-overlay .text-muted,
      #portalSection small,
      #portalSection span,
      #portalSection li {
        color: var(--text-muted-contrast) !important;
      }

      #display_name,
      #full_name,
      #activeLeaseLabel,
      #user_type_label {
        color: #fff !important;
        font-weight: 600;
      }

      #portalSection .text-primary,
      #portalSection .badge.bg-primary,
      #portalSection .text-info,
      #portalSection code.text-primary,
      .modal-overlay .text-primary {
        color: var(--text-highlight) !important;
      }

      #portalSection .table,
      #portalSection .table td,
      #portalSection .table tbody,
      #portalSection .table tr,
      #portalSection .table-responsive {
        background: transparent !important;
        color: #fff !important;
      }

      #portalSection .table th {
        color: #ffd54f !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.35) !important;
      }

      #portalSection .table-hover tbody tr:hover {
        background: rgba(255, 255, 255, 0.09) !important;
      }

      .btn-primary,
      #portalSection .btn.btn-dark,
      #loginSection #loginBtn {
        background: #ffd54f !important;
        color: #000 !important;
        border-color: #ffd54f !important;
        font-weight: 700;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn-danger,
      .btn-outline-danger:hover {
        background: #e53935 !important;
        color: #fff !important;
        border-color: #e53935 !important;
      }

      .btn-outline-secondary,
      .btn-light,
      .btn-outline-primary,
      #portalSection .btn-secondary {
        background: rgba(255, 255, 255, 0.14) !important;
        color: #fff !important;
        border: 1px solid rgba(255, 255, 255, 0.35) !important;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn-primary:hover,
      #portalSection .btn.btn-dark:hover,
      #loginSection #loginBtn:hover,
      .btn-outline-secondary:hover,
      .btn-light:hover,
      .btn-outline-primary:hover,
      #portalSection .btn-secondary:hover {
        transform: scale(1.03);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .portal-view-switch {
        border-bottom: 2px solid #ffd54f;
      }

      .portal-view-switch .btn {
        background: var(--glass-strong);
        color: #fff;
        border: 1px solid var(--glass-border);
      }

      .portal-view-switch .btn.active {
        background: #ffd54f;
        color: #000;
        border-color: #ffd54f;
      }

      #searchBar {
        background: rgba(0, 0, 0, 0.75) !important;
        color: #fff !important;
        border: 1px solid #ffd54f !important;
      }

      #searchBar::placeholder {
        color: rgba(255, 255, 255, 0.7) !important;
      }



      /* ===== HEADER STYLE ===== */
      .main-header {
        position: relative;
        width: 100%;
        background: #0d47a1;
        overflow: hidden;
      }

      .main-header::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 60%;
        height: 100%;
        background: linear-gradient(135deg, #42a5f5, #1e88e5);
        clip-path: polygon(30% 0, 100% 0, 100% 100%, 0% 100%);
        z-index: 0;
      }

      .header-content {
        position: relative;
        z-index: 1;
        padding: 20px 40px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .logo-section {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .school-logo {
        height: 70px;
        width: auto;
        transition: transform 0.3s ease;
      }

      .school-logo:hover {
        transform: scale(1.08);
      }

      .system-title h1 {
        margin: 0;
        font-weight: 600;
        color: #ffffff;
      }

      /* ===== FOOTER STYLE ===== */
      .main-footer {
        position: relative;
        background: #1b5e20;
        overflow: hidden;
        color: white;
        padding: 25px;
        margin-top: 60px;
        text-align: center;
        animation: fadeUp 0.8s ease;
        flex-shrink: 0;
      }

      .footer-purpose-link {
        color: #60a5fa;
        font-weight: 700;
        text-decoration: none;
      }
      .footer-purpose-link:hover {
        text-decoration: underline;
      }

      .main-footer::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 50%;
        height: 100%;
        background: linear-gradient(135deg, #66bb6a, #a5d6a7);
        clip-path: polygon(40% 0, 100% 0, 100% 100%, 0% 100%);
        z-index: 0;
      }

      .footer-content {
        position: relative;
        z-index: 1;
      }

      .footer-content p {
        margin: 5px 0;
        font-size: 14px;
      }

      @keyframes slideDown {
        from {
          transform: translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(15px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        .header-content {
          padding: 14px 16px;
        }

        .school-logo {
          height: 52px;
        }

        .system-title h1 {
          font-size: 1rem;
          line-height: 1.25;
        }

        .mobile-nav {
          padding: 12px 14px;
        }

        .main-footer {
          margin-top: 30px;
          padding: 16px;
        }

        #portalSection .container {
          padding-left: 12px;
          padding-right: 12px;
        }

        .book-item {
          padding: 14px;
          margin-bottom: 0;
        }

        .book-item,
        .book-card,
        .login-card,
        .mobile-nav,
        .custom-modal,
        .account-dropdown,
        #portalSection .container,
        #portalSection .card,
        #portalSection .modal-content,
        .lbas-definition {
          backdrop-filter: none;
          -webkit-backdrop-filter: none;
          background: rgba(0, 0, 0, 0.6);
        }
      }

      @media (max-width: 576px) {
        #bookContainer {
          grid-template-columns: 1fr;
        }

        .system-title h1 {
          font-size: 0.92rem;
        }
      }

    </style>
  </head>
  <body class="main-wrapper">
    <!-- ===== HEADER SECTION ===== -->
    <header class="main-header">
      <div class="header-content">
        <div class="logo-section">
            <img src="https://up.yimg.com/ib/th/id/OIP.3wZU8KYQ9wGoRl3eoloR0QHaHa?pid=Api&rs=1&c=1&qlt=95&w=114&h=114"
                 alt="School Logo"
                 class="school-logo">
            <div class="system-title">
          <h1>Library Borrowing and Assistance System</h1>
            </div>
        </div>
      </div>
    </header>

    <div class="network-banner">LBAS SECURE CROSS-DATABASE PROTOCOL V7.2 BETA</div>

    <div
      id="fabReview"
      class="rating-fab"
      onclick="toggleModal('ratingModal', true)"
    >
      ⭐
    </div>

    <div id="ratingModal" class="modal-overlay">
      <div class="custom-modal">
        <h4 class="fw-bold">Experience Rating</h4>
        <p class="text-muted small">Help our developers improve the system.</p>
        <div class="star-container">
          <span class="star" onclick="setStars(1)">★</span>
          <span class="star" onclick="setStars(2)">★</span>
          <span class="star" onclick="setStars(3)">★</span>
          <span class="star" onclick="setStars(4)">★</span>
          <span class="star" onclick="setStars(5)">★</span>
        </div>
        <textarea
          id="ratingFeedback"
          class="form-control mb-3 bg-light border-0"
          placeholder="Additional feedback (optional)..."
          rows="3"
        ></textarea>
        <div class="d-flex gap-2">
          <button
            class="btn btn-light w-100 rounded-pill fw-bold"
            onclick="toggleModal('ratingModal', false)"
          >
            CLOSE
          </button>
          <button
            class="btn btn-dark w-100 rounded-pill fw-bold"
            onclick="submitRating()"
          >
            SUBMIT
          </button>
        </div>
      </div>
    </div>

    <div id="registerModal" class="modal-overlay">
      <div class="custom-modal text-start">
        <h4 class="fw-bold text-center mb-1">New Application</h4>
        <p class="text-muted small text-center mb-4">
          Request access from the Librarian.
        </p>

        <div
          class="upload-circle"
          onclick="document.getElementById('regPhoto').click()"
        >
          <i class="fas fa-camera upload-icon" id="uploadIcon"></i>
          <img id="previewImg" />
        </div>
        <input
          type="file"
          id="regPhoto"
          accept="image/*"
          style="display: none"
          onchange="previewPhoto(this)"
        />
        <p class="text-center small text-muted mb-3" style="font-size: 0.7rem">
          Tap circle to add ID photo
        </p>

        <div class="mb-3">
          <label class="small fw-bold ms-2">Full Name</label>
          <input
            type="text"
            id="regName"
            class="form-control rounded-pill bg-light border-0 px-3"
            placeholder="e.g. Juan Dela Cruz"
          />
        </div>
        <div class="mb-3">
          <label class="small fw-bold ms-2">School ID Number</label>
          <input
            type="text"
            id="regID"
            class="form-control rounded-pill bg-light border-0 px-3"
            placeholder="e.g. 2023-0015"
          />
        </div>
        <div class="mb-4">
          <label class="small fw-bold ms-2">Create Password</label>
          <input
            type="password"
            id="regPass"
            class="form-control rounded-pill bg-light border-0 px-3"
            placeholder="••••••••"
          />
        </div>

        <button
          class="btn btn-primary w-100 rounded-pill fw-bold py-2 mb-2 shadow-sm"
          onclick="submitRegistration()"
        >
          SUBMIT REQUEST
        </button>
        <button
          class="btn btn-outline-secondary w-100 rounded-pill fw-bold py-2"
          onclick="toggleModal('registerModal', false)"
        >
          CANCEL
        </button>
      </div>
    </div>

    <div id="statusModal" class="modal-overlay">
      <div class="custom-modal">
        <div class="mb-3">
          <i
            id="statusIcon"
            class="fas fa-check-circle text-success"
            style="font-size: 3rem"
          ></i>
        </div>
        <h4 id="statusTitle" class="fw-bold">Success</h4>
        <p id="statusMsg" class="text-muted small">Operation completed.</p>
        <button
          class="btn btn-dark w-100 rounded-pill fw-bold"
          onclick="toggleModal('statusModal', false)"
        >
          UNDERSTOOD
        </button>
      </div>
    </div>

    <div id="loginSection" class="content">
      <div class="login-card">
        <div class="mb-4">
          <div
            class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center shadow-lg"
            style="width: 60px; height: 60px"
          >
            <i class="fas fa-book-reader fa-lg"></i>
          </div>
        </div>
        <h3 class="fw-bold text-dark mb-1">LBAS PORTAL</h3>
        <p class="text-muted small mb-4">Library Book Access System v7.2 Beta</p>

        <div class="mb-3">
          <input
            type="text"
            id="school_id_input"
            class="form-control form-control-lg text-center bg-light border-0 rounded-pill"
            placeholder="School ID"
          />
        </div>
        <div class="mb-4">
          <input
            type="password"
            id="password_input"
            class="form-control form-control-lg text-center bg-light border-0 rounded-pill"
            placeholder="Password"
          />
        </div>

        <button
          id="loginBtn"
          class="btn btn-dark btn-lg w-100 rounded-pill fw-bold shadow-sm mb-3"
          onclick="handleLogin()"
        >
          SECURE LOGIN
        </button>

        <div class="d-flex align-items-center my-3">
          <hr class="flex-grow-1" />
          <span class="px-2 text-muted small">New Student?</span>
          <hr class="flex-grow-1" />
        </div>

        <button
          class="btn btn-outline-primary w-100 rounded-pill fw-bold"
          onclick="toggleModal('registerModal', true)"
        >
          CREATE ACCOUNT
        </button>

        <div
          id="loginError"
          class="alert alert-danger small mt-3 fw-bold rounded-3 border-0 py-2"
          style="display: none; font-size: 0.75rem"
        >
          <i class="fas fa-exclamation-triangle me-1"></i>
          <span id="errorText">CREDENTIALS INVALID</span>
        </div>
      </div>
      <div class="mt-4 text-muted small opacity-50">
        Authorized Access Only | V7.2-BETA
      </div>
    </div>

    <div id="portalSection" class="content" style="display: none">
      <nav class="mobile-nav shadow-sm">
        <div>
          <span
            class="badge bg-primary text-uppercase mb-1"
            id="user_type_label"
            style="font-size: 9px; letter-spacing: 0.5px"
            >USER</span
          >
          <h6 class="fw-bold m-0" id="display_name" style="font-size: 0.95rem">
            User Name
          </h6>
        </div>
        <button
          class="btn btn-sm btn-light rounded-pill border px-3 fw-bold"
          onclick="toggleAccount()"
        >
          <i class="fas fa-user-circle me-1"></i> Profile
        </button>
      </nav>

      <div id="accountPanel" class="account-dropdown">
        <div class="d-flex align-items-center mb-3">
          <img
            id="user_pic"
            src=""
            class="rounded-circle me-3 shadow-sm"
            style="
              width: 65px;
              height: 65px;
              object-fit: cover;
              border: 3px solid var(--accent);
            "
          />
          <div>
            <strong id="full_name" class="d-block" style="font-size: 1.1rem"
              >Name</strong
            >
            <code class="text-muted small fw-bold" id="id_val"></code><br />
            <span
              class="badge bg-light text-dark border mt-1"
              id="database_source"
              style="font-size: 9px"
            ></span>
          </div>
        </div>
        <hr />
        <p class="fw-bold small mb-2 text-uppercase text-muted" id="activeLeaseLabel">
          <i class="fas fa-history me-1"></i> Active Leases (<span id="reservationCount">0</span>/5)
        </p>
        <div id="activeHistory" class="mb-3"></div>
        <button
          class="btn btn-danger btn-sm w-100 rounded-pill fw-bold py-2"
          onclick="logout()"
        >
          TERMINATE SESSION
        </button>
      </div>

      <div class="container py-4">
        <div id="lbasInfo" class="lbas-definition" style="display: none">
          <h6 class="fw-bold mb-2">
            <i class="fas fa-shield-alt me-1"></i> ADMIN OVERRIDE:
          </h6>
          <div class="small text-muted">
            You have Staff privileges. You can browse the catalog here, but
            management tools are located on the <b>Admin Dashboard</b>.
          </div>
        </div>

        <div class="btn-group w-100 mb-4 portal-view-switch" role="group">
          <button
            class="btn btn-outline-secondary fw-bold active"
            id="catalogMenuBtn"
            onclick="switchPortalView('catalog')"
          >
            Catalog
          </button>
          <button
            class="btn btn-outline-secondary fw-bold"
            id="leaderboardMenuBtn"
            onclick="switchPortalView('leaderboard')"
          >
            Leaderboard
          </button>
        </div>

        <div id="catalogSection">
          <div class="position-relative mb-4">
            <input
              type="text"
              id="searchBar"
              class="form-control form-control-lg border-0 shadow-sm rounded-pill ps-5"
              placeholder="Find books..."
              onkeyup="loadData()"
            />
            <i
              class="fas fa-search position-absolute text-muted"
              style="left: 20px; top: 18px"
            ></i>
          </div>

          <div class="filter-wrapper" id="catFilterList"></div>

          <div id="bookContainer" class="pb-5"></div>
        </div>

        <div id="leaderboardSection" style="display: none">
          <div class="card border-0 shadow-sm p-4">
            <h5 class="fw-bold mb-3">
              <i class="fas fa-trophy text-warning me-2"></i>Top Borrowers This
              Month
            </h5>
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                  <tr class="small text-uppercase">
                    <th>Rank</th>
                    <th>Borrower</th>
                    <th>Total Borrowed</th>
                  </tr>
                </thead>
                <tbody id="leaderboardBorrowersBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="leaderboardProfileModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
          <div class="modal-header border-0 pb-0">
            <h5 class="fw-bold"><i class="fas fa-id-card text-primary me-2"></i>Borrower Profile</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-4">
            <div class="card border-0 bg-light rounded-4">
              <div class="card-body text-center">
                <img id="leaderboardProfilePhoto" src="/Profile/default.png" class="rounded-circle shadow-sm mb-3" style="width:90px;height:90px;object-fit:cover;" alt="Profile">
                <h5 id="leaderboardProfileName" class="fw-bold mb-1">-</h5>
                <div id="leaderboardProfileId" class="text-muted small mb-3">ID: -</div>
                <div class="d-flex justify-content-between small"><span class="text-muted">Total borrowed this month</span><span id="leaderboardProfileTotal" class="fw-bold">0</span></div>
                <div class="d-flex justify-content-between small mt-2"><span class="text-muted">Most borrowed book</span><span id="leaderboardProfileBook" class="fw-bold text-end">No records</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentID = null;
      let currentToken = null;
      let selectedCategory = "All";
      let selectedStars = 5;
      let availableCategories = [];
      let leaderboardProfileModal = null;
      const ALL_COLLECTION_LIMIT = 20;
      const CATEGORY_LIMIT = 10;
      const MAX_ACTIVE_RESERVATIONS = 5;
      const RESERVATION_DURATION_MS = 30 * 60 * 1000;
      const userReservations = {};
      const userActiveLeases = {};
      const pendingReservationRequests = new Set();
      let latestBooksByCode = {};
      let allCollectionOrder = [];
      let categoryCollectionOrder = {};

      function shuffleBooks(books) {
        const shuffled = [...books];
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
      }

      function getRandomizedAllCollection(books, limit) {
        const grouped = books.reduce((acc, book) => {
          const key = book.category || "General";
          if (!acc[key]) acc[key] = [];
          acc[key].push(book);
          return acc;
        }, {});

        const pools = Object.values(grouped)
          .map((group) => shuffleBooks(group))
          .filter((group) => group.length > 0);

        const mixed = [];
        while (mixed.length < limit && pools.some((pool) => pool.length > 0)) {
          pools.forEach((pool) => {
            if (pool.length > 0 && mixed.length < limit) {
              mixed.push(pool.pop());
            }
          });
        }
        return shuffleBooks(mixed);
      }

      function normalizeReservation(transaction) {
        const expiryDate = transaction.expiry
          ? new Date(transaction.expiry)
          : transaction.date
            ? new Date(new Date(transaction.date).getTime() + RESERVATION_DURATION_MS)
            : new Date(Date.now() + RESERVATION_DURATION_MS);

        return {
          book_no: transaction.book_no,
          expiry: expiryDate.toISOString(),
        };
      }

      function getReservationKey(schoolID) {
        return String(schoolID || "").trim().toLowerCase();
      }

      function getNormalizedStatus(transaction) {
        return String(transaction?.status || "").trim().toLowerCase();
      }

      function getTransactionSchoolId(transaction) {
        return getReservationKey(transaction?.school_id ?? transaction?.schoolID ?? transaction?.user_id);
      }

      function parseTransactionPayload(payload) {
        if (Array.isArray(payload)) return payload;
        if (payload && Array.isArray(payload.transactions)) return payload.transactions;
        return [];
      }

      function normalizeLease(transaction) {
        const expiryDate = transaction.expiry
          ? new Date(transaction.expiry)
          : transaction.date
            ? new Date(
                new Date(transaction.date).getTime() +
                  (transaction.status === "Borrowed"
                    ? 7 * 24 * 60 * 60 * 1000
                    : RESERVATION_DURATION_MS),
              )
            : new Date(Date.now() + RESERVATION_DURATION_MS);

        const book = latestBooksByCode[transaction.book_no] || {};
        return {
          book_no: transaction.book_no,
          title: transaction.title || book.title || "Unknown Title",
          status: transaction.status,
          expiry: expiryDate.toISOString(),
        };
      }

      function cleanupExpiredReservationsForUser(schoolID) {
        const key = getReservationKey(schoolID);
        const now = Date.now();

        if (!Array.isArray(userReservations[key])) {
          userReservations[key] = [];
        }

        userReservations[key] = userReservations[key].filter((reservation) => {
          const expiryTime = new Date(reservation.expiry).getTime();
          return Number.isFinite(expiryTime) && expiryTime > now;
        });

        return userReservations[key];
      }

      function syncUserReservations(transactions, schoolID) {
        if (!schoolID) return [];

        const key = getReservationKey(schoolID);

        const reservations = transactions
          .filter(
            (transaction) =>
              getTransactionSchoolId(transaction) === key &&
              getNormalizedStatus(transaction) === "reserved",
          )
          .map(normalizeReservation);

        userReservations[key] = reservations;
        return cleanupExpiredReservationsForUser(schoolID);
      }

      function cleanupExpiredLeasesForUser(schoolID) {
        const key = getReservationKey(schoolID);
        const now = Date.now();

        if (!Array.isArray(userActiveLeases[key])) {
          userActiveLeases[key] = [];
        }

        userActiveLeases[key] = userActiveLeases[key].filter((lease) => {
          const expiryTime = new Date(lease.expiry).getTime();
          return Number.isFinite(expiryTime) && expiryTime > now;
        });

        return userActiveLeases[key];
      }

      function syncUserActiveLeases(transactions, schoolID) {
        if (!schoolID) return [];
        const key = getReservationKey(schoolID);
        const leases = transactions
          .filter(
            (transaction) => {
              const status = getNormalizedStatus(transaction);
              return (
                getTransactionSchoolId(transaction) === key &&
                (status === "reserved" || status === "borrowed")
              );
            },
          )
          .map(normalizeLease);

        userActiveLeases[key] = leases;
        return cleanupExpiredLeasesForUser(schoolID);
      }

      function renderActiveLeases() {
        const key = getReservationKey(currentID);
        const active = cleanupExpiredLeasesForUser(key)
          .slice()
          .sort((a, b) => new Date(a.expiry) - new Date(b.expiry));
        const reservationCount = active.filter(
          (lease) => getNormalizedStatus(lease) === "reserved",
        ).length;

        const reservationCountNode = document.getElementById("reservationCount");
        if (reservationCountNode) {
          reservationCountNode.textContent = String(reservationCount);
        }

        const activeLeaseLabel = document.getElementById("activeLeaseLabel");
        if (activeLeaseLabel) {
          activeLeaseLabel.innerHTML = `<i class="fas fa-history me-1"></i> Active Leases (${active.length}/${MAX_ACTIVE_RESERVATIONS})`;
        }

        document.getElementById("activeHistory").innerHTML =
          active
            .map(
              (lease) => `
                <div class="p-3 border rounded-3 mb-2 bg-light d-flex justify-content-between align-items-center gap-2">
                  <div>
                    <div class="fw-bold text-dark">${lease.title}</div>
                    <code class="small text-primary fw-bold">${lease.book_no}</code><br>
                    <span class="badge ${getNormalizedStatus(lease) === "reserved" ? "bg-warning text-dark" : "bg-success"}">${lease.status}</span>
                  </div>
                  <div class="text-end">
                    <span class="timer small fw-bold text-primary d-block" data-expiry="${lease.expiry}" data-status="${lease.status}" data-book-no="${lease.book_no}">Calculating...</span>
                    ${getNormalizedStatus(lease) === "reserved" ? `<button class="btn btn-sm btn-outline-danger rounded-pill mt-1" onclick="releaseReservation('${lease.book_no}')">Release</button>` : ""}
                  </div>
                </div>`,
            )
            .join("") ||
          '<p class="text-muted small text-center mt-3 border p-3 rounded-3 dashed">No active reservations.</p>';

        updateTimers();
      }

      async function loadReservations() {
        if (!currentID) return;
        try {
          const tRes = await fetch("/api/transactions");
          const trans = parseTransactionPayload(await tRes.json());
          syncUserReservations(trans, currentID);
          syncUserActiveLeases(trans, currentID);
          renderActiveLeases();
        } catch (e) {
          console.error("Unable to refresh reservations.");
        }
      }

      async function fetchUserActiveReservations() {
        await loadReservations();
      }

      async function handleLogin() {
        const id = document.getElementById("school_id_input").value.trim();
        const pwd = document.getElementById("password_input").value.trim();
        if (!id) return;

        const btn = document.getElementById("loginBtn");
        const err = document.getElementById("loginError");
        const errTxt = document.getElementById("errorText");

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> VERIFYING...';
        btn.disabled = true;
        err.style.display = "none";

        try {
          const res = await fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ school_id: id, password: pwd }),
          });

          const data = await res.json();

          if (data.success) {
            currentID = id;
            currentToken = data.token;
            localStorage.setItem("lbas_id", id);
            localStorage.setItem("lbas_token", currentToken);
            initPortal(data.profile);
          } else {
            err.style.display = "block";
            if (res.status === 401 && data.message.includes("Pending")) {
              showStatusPopup(
                "warning",
                "Approval Pending",
                "Your account is waiting for Librarian review. Please check back later.",
              );
              err.style.display = "none"; // Hide the red error box if showing popup
            } else if (res.status === 404) {
              errTxt.innerText = "ID NOT FOUND / REQUEST REJECTED";
            } else {
              errTxt.innerText = data.message || "AUTHENTICATION FAILED";
            }
          }
        } catch (e) {
          err.style.display = "block";
          errTxt.innerText = "SERVER UNREACHABLE";
        } finally {
          btn.innerText = "SECURE LOGIN";
          btn.disabled = false;
        }
      }

      function previewPhoto(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById("previewImg").src = e.target.result;
            document.getElementById("previewImg").style.display = "block";
            document.getElementById("uploadIcon").style.display = "none";
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      async function submitRegistration() {
        const name = document.getElementById("regName").value;
        const id = document.getElementById("regID").value;
        const pwd = document.getElementById("regPass").value;
        const file = document.getElementById("regPhoto").files[0];

        if (!name || !id || !pwd) return alert("Please fill all fields.");

        const fd = new FormData();
        fd.append("name", name);
        fd.append("school_id", id);
        fd.append("password", pwd);
        if (file) fd.append("photo", file);

        try {
          const res = await fetch("/api/register_student", {
            method: "POST",
            body: fd,
          });
          const data = await res.json();

          toggleModal("registerModal", false); // Close form

          if (data.success) {
            showStatusPopup(
              "success",
              "Application Sent!",
              "Your request has been forwarded to the Librarian. You cannot log in until approved.",
            );
            document.getElementById("regName").value = "";
            document.getElementById("regID").value = "";
            document.getElementById("regPass").value = "";
            document.getElementById("previewImg").src = "";
            document.getElementById("previewImg").style.display = "none";
            document.getElementById("uploadIcon").style.display = "block";
          } else {
            showStatusPopup(
              "error",
              "Registration Failed",
              data.message || "ID already exists or invalid data.",
            );
          }
        } catch (e) {
          alert("Network Error during registration.");
        }
      }

      function showStatusPopup(type, title, msg) {
        const icon = document.getElementById("statusIcon");
        const h4 = document.getElementById("statusTitle");

        document.getElementById("statusMsg").innerText = msg;

        if (type === "success") {
          icon.className = "fas fa-check-circle text-success";
          h4.className = "fw-bold text-success";
        } else if (type === "warning") {
          icon.className = "fas fa-clock text-warning";
          h4.className = "fw-bold text-warning";
        } else {
          icon.className = "fas fa-times-circle text-danger";
          h4.className = "fw-bold text-danger";
        }

        h4.innerText = title;
        toggleModal("statusModal", true);
      }

      function renderCategoryFilters() {
        const list = document.getElementById("catFilterList");
        let html = `<div class="cat-pill ${selectedCategory === "All" ? "active" : ""}" onclick="setCategoryFilter('All')">All Collection</div>`;
        availableCategories.forEach((cat) => {
          html += `<div class="cat-pill ${selectedCategory === cat ? "active" : ""}" onclick="setCategoryFilter('${cat}')">${cat}</div>`;
        });
        list.innerHTML = html;
      }

      async function fetchCategories() {
        try {
          const res = await fetch("/api/categories");
          const cats = await res.json();
          availableCategories = Array.isArray(cats) ? cats : [];
          renderCategoryFilters();
        } catch (e) {
          availableCategories = [
            "General",
            "Mathematics",
            "Science",
            "Literature",
          ];
          renderCategoryFilters();
        }
      }

      function switchPortalView(view) {
        const isLeaderboard = view === "leaderboard";
        document.getElementById("catalogSection").style.display = isLeaderboard
          ? "none"
          : "block";
        document.getElementById("leaderboardSection").style.display =
          isLeaderboard ? "block" : "none";
        document
          .getElementById("catalogMenuBtn")
          .classList.toggle("active", !isLeaderboard);
        document
          .getElementById("leaderboardMenuBtn")
          .classList.toggle("active", isLeaderboard);
        if (isLeaderboard) loadLeaderboard();
      }

      async function loadLeaderboard() {
        try {
          const res = await fetch("/api/monthly_leaderboard");
          const data = await res.json();
          const rows = data.top_borrowers || [];
          document.getElementById("leaderboardBorrowersBody").innerHTML =
            rows
              .map(
                (row, idx) => `
                  <tr role="button" onclick="openLeaderboardProfile('${row.school_id}')">
                    <td class="fw-bold">#${row.rank || idx + 1}</td>
                    <td>
                      <div class="d-flex align-items-center gap-2">
                        <img src="/Profile/${row.photo || "default.png"}" class="rounded-circle" style="width:36px;height:36px;object-fit:cover;" alt="${row.name}">
                        <div>
                          <div class="fw-bold">${row.name || row.school_id}</div>
                          <div class="small text-muted">${row.school_id}</div>
                        </div>
                      </div>
                    </td>
                    <td>${row.total_borrowed}</td>
                  </tr>
            `,
              )
              .join("") ||
            '<tr><td colspan="3" class="text-muted text-center py-4">No borrow records yet for this month.</td></tr>';
        } catch (e) {
          document.getElementById("leaderboardBorrowersBody").innerHTML =
            '<tr><td colspan="3" class="text-danger text-center py-4">Unable to load leaderboard.</td></tr>';
        }
      }

      async function openLeaderboardProfile(id) {
        try {
          const res = await fetch(
            "/api/leaderboard_profile/" + encodeURIComponent(id),
          );
          const data = await res.json();
          if (!res.ok || !data.success) throw new Error();
          const p = data.profile;
          document.getElementById("leaderboardProfilePhoto").src =
            `/Profile/${p.photo || "default.png"}`;
          document.getElementById("leaderboardProfileName").innerText =
            p.name || p.school_id;
          document.getElementById("leaderboardProfileId").innerText =
            `ID: ${p.school_id || "-"}`;
          document.getElementById("leaderboardProfileTotal").innerText =
            p.total_borrowed ?? 0;
          document.getElementById("leaderboardProfileBook").innerText =
            p.most_borrowed_book || "No records";
          leaderboardProfileModal.show();
        } catch (e) {
          console.error("Unable to load leaderboard profile.");
        }
      }

      function initPortal(profile) {
        if (!profile) return logout();

        document.getElementById("loginSection").style.display = "none";
        document.getElementById("portalSection").style.display = "block";

        const isLibrarian = profile.category === "Staff";

        if (isLibrarian) {
          document.getElementById("lbasInfo").style.display = "block";
        }

        document.getElementById("user_type_label").innerText = isLibrarian
          ? "LIBRARIAN MODE"
          : "STUDENT ACCESS";
        document.getElementById("user_type_label").className = isLibrarian
          ? "badge bg-danger text-uppercase mb-1"
          : "badge bg-primary text-uppercase mb-1";
        document.getElementById("database_source").innerText = isLibrarian
          ? "CREDENTIAL: STAFF"
          : "CREDENTIAL: USER";

        document.getElementById("display_name").innerText = profile.name
          ? profile.name.split(" ")[0]
          : "User";
        document.getElementById("full_name").innerText =
          profile.name || "Unknown User";
        document.getElementById("id_val").innerText =
          "ID: " + profile.school_id;
        document.getElementById("user_pic").src = profile.photo
          ? "/Profile/" + profile.photo
          : "/Profile/default.png";
        switchPortalView("catalog");

        fetchCategories();
        fetchUserActiveReservations();
        loadData();
        checkRatingStatus();
        setInterval(loadReservations, 30000);
        setInterval(updateTimers, 1000);
      }

      async function loadData() {
        try {
          const [bRes, tRes] = await Promise.all([
            fetch("/api/books"),
            fetch("/api/transactions"),
          ]);
          const books = await bRes.json();
          const trans = parseTransactionPayload(await tRes.json());
          latestBooksByCode = books.reduce((acc, book) => {
            acc[book.book_no] = book;
            return acc;
          }, {});
          syncUserReservations(trans, currentID);
          syncUserActiveLeases(trans, currentID);
          const search = document
            .getElementById("searchBar")
            .value.toLowerCase();
          const isSearching = search.length > 0;

          const filtered = books.filter((b) => {
            const matchesSearch =
              b.title.toLowerCase().includes(search) ||
              b.book_no.toLowerCase().includes(search);
            const matchesCategory =
              isSearching ||
              selectedCategory === "All" ||
              b.category === selectedCategory;
            return matchesSearch && matchesCategory;
          });

          if (allCollectionOrder.length === 0) {
            allCollectionOrder = getRandomizedAllCollection(books, ALL_COLLECTION_LIMIT).map(
              (book) => book.book_no,
            );
          }

          const categoryKey = selectedCategory;
          if (
            !isSearching &&
            selectedCategory !== "All" &&
            !categoryCollectionOrder[categoryKey]
          ) {
            categoryCollectionOrder[categoryKey] = shuffleBooks(filtered)
              .slice(0, CATEGORY_LIMIT)
              .map((book) => book.book_no);
          }

          const displayBooks = isSearching
            ? filtered
            : selectedCategory === "All"
              ? allCollectionOrder
                  .map((bookNo) => latestBooksByCode[bookNo])
                  .filter((book) => book && filtered.some((f) => f.book_no === book.book_no))
              : (categoryCollectionOrder[categoryKey] || [])
                  .map((bookNo) => latestBooksByCode[bookNo])
                  .filter(Boolean);

          document.getElementById("bookContainer").innerHTML =
            displayBooks
              .map(
                (b) => `
                <div class="book-item shadow-sm">
                    <span class="status-tag tag-${b.status.toLowerCase()}">${b.status}</span>
                    <span class="text-muted" style="font-size: 10px; font-weight:700;">${b.category.toUpperCase()}</span>
                    <div class="fw-bold text-dark mt-1">${b.title}</div>
                    <code class="small text-primary fw-bold">${b.book_no}</code>
                    ${b.status === "Available" ? `<button class="btn-action shadow-sm" data-book-no="${b.book_no}" onclick="reserveBook('${b.book_no}')">RESERVE BOOK</button>` : ""}
                </div>`,
              )
              .join("") ||
            '<div class="text-center text-muted mt-5"><i class="fas fa-book-open fa-2x mb-3 opacity-25"></i><br>No books found.</div>';

          renderActiveLeases();
        } catch (e) {
          console.error("Data Sync Error");
        }
      }

      async function reserveBook(no) {
        const schoolID = String(currentID);
        if (!schoolID) return;
        if (pendingReservationRequests.has(no)) return;

        const reserveButton = document.querySelector(
          `button[data-book-no="${no}"]`,
        );
        pendingReservationRequests.add(no);
        if (reserveButton) reserveButton.disabled = true;

        try {
          if (!confirm("Reserve this book? You have 30 minutes to claim it.")) {
            return;
          }

          const res = await fetch("/api/reserve", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              book_no: no,
              school_id: currentID,
              token: currentToken,
            }),
          });

          const result = await res.json();

          if (!res.ok || !result.success || result.status === "error") {
            alert(result.message || "Unable to complete reservation.");
            return;
          }

          const key = getReservationKey(currentID);
          if (!Array.isArray(userReservations[key])) userReservations[key] = [];
          if (!Array.isArray(userActiveLeases[key])) userActiveLeases[key] = [];

          const expiry = new Date(Date.now() + RESERVATION_DURATION_MS).toISOString();
          const leaseTitle = (latestBooksByCode[no] && latestBooksByCode[no].title) ||
            result.title ||
            "Unknown Title";

          userReservations[key].push({
            book_no: no,
            expiry,
          });
          userActiveLeases[key] = userActiveLeases[key].filter(
            (lease) => lease.book_no !== no,
          );
          userActiveLeases[key].push({
            book_no: no,
            title: leaseTitle,
            status: "Reserved",
            expiry,
          });
          renderActiveLeases();

          showStatusPopup(
            "success",
            "Reservation Confirmed",
            "Please proceed to the librarian desk to claim your book.",
          );
          await loadReservations();
          loadData();
        } catch (e) {
          showStatusPopup(
            "error",
            "Action Failed",
            "Unable to complete reservation right now. Please try again.",
          );
        } finally {
          pendingReservationRequests.delete(no);
          if (reserveButton) reserveButton.disabled = false;
        }
      }

      async function releaseReservation(bookNo) {
        if (!currentID || !bookNo) return;
        if (!confirm("Release this reservation?")) return;

        try {
          const res = await fetch("/api/process_transaction", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              book_no: bookNo,
              action: "return",
              school_id: currentID,
            }),
          });
          const data = await res.json();
          if (!res.ok || !data.success) {
            alert(data.message || "Unable to release reservation.");
            return;
          }

          const key = getReservationKey(currentID);
          userReservations[key] = (userReservations[key] || []).filter(
            (reservation) => reservation.book_no !== bookNo,
          );
          userActiveLeases[key] = (userActiveLeases[key] || []).filter(
            (lease) => lease.book_no !== bookNo,
          );
          renderActiveLeases();
          await loadReservations();
          loadData();
        } catch (e) {
          alert("Unable to release reservation right now.");
        }
      }

      function setCategoryFilter(cat) {
        selectedCategory = cat;
        document.querySelectorAll("#catFilterList .cat-pill").forEach((p) => {
          const isAll = cat === "All" && p.innerText.includes("All");
          p.classList.toggle("active", p.innerText.trim() === cat || isAll);
        });
        loadData();
      }

      function updateTimers() {
        let foundExpiredReservation = false;
        document.querySelectorAll(".timer").forEach((el) => {
          const diff = new Date(el.dataset.expiry) - new Date();
          if (diff <= 0) {
            if (el.dataset.status === "Reserved") {
              foundExpiredReservation = true;
              return;
            }
            el.innerText = "EXPIRED";
            el.classList.add("text-danger");
          } else {
            const m = Math.floor(diff / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            el.innerText = `${m}m ${s}s remaining`;
          }
        });

        if (foundExpiredReservation) {
          cleanupExpiredReservationsForUser(currentID);
          cleanupExpiredLeasesForUser(currentID);
          renderActiveLeases();
        }
      }

      async function checkRatingStatus() {
        if (!currentID) return;
        try {
          const res = await fetch(`/api/rating_status/${currentID}`);
          const data = await res.json();
          document.getElementById("fabReview").style.display = data.show
            ? "flex"
            : "none";
        } catch (e) {}
      }

      function toggleModal(id, show) {
        document.getElementById(id).style.display = show ? "flex" : "none";
        if (id === "ratingModal" && show) setStars(5);
      }

      function setStars(count) {
        selectedStars = count;
        document
          .querySelectorAll(".star")
          .forEach((s, i) => s.classList.toggle("selected", i < count));
      }

      async function submitRating() {
        const feedback = document.getElementById("ratingFeedback").value;
        const res = await fetch("/api/rate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            school_id: currentID,
            token: currentToken,
            stars: selectedStars,
            feedback: feedback,
          }),
        });
        const data = await res.json();
        if (data.success) {
          toggleModal("ratingModal", false);
          checkRatingStatus();
          showStatusPopup(
            "success",
            "Feedback Sent",
            "Thank you for rating LBAS!",
          );
        }
      }

      function toggleAccount() {
        const p = document.getElementById("accountPanel");
        p.style.display = p.style.display === "block" ? "none" : "block";
      }
      function logout() {
        localStorage.clear();
        location.reload();
      }

      window.onload = () => {
        leaderboardProfileModal = new bootstrap.Modal(
          document.getElementById("leaderboardProfileModal"),
        );
        fetchCategories();
        const savedID = localStorage.getItem("lbas_id");
        if (savedID) {
          fetch("/api/user/" + savedID)
            .then((r) => r.json())
            .then((d) => {
              if (d.profile && d.profile.status !== "pending")
                initPortal(d.profile);
              else logout();
            })
            .catch(logout);
        }
      };
    </script>

    <!-- ===== FOOTER SECTION ===== -->
    <footer class="main-footer">
      <div class="footer-content">
        <p>© 2025 Library Borrowing and Assistance System</p>
        <p>The Makers of the System</p>
        <p>
          Purpose:
          <a class="footer-purpose-link" href="/creators">Creators Page</a>
        </p>
      </div>
    </footer>
  </body>
</html>
